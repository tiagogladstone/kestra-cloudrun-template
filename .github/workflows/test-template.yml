name: Test Template

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-worker-template:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Worker Template Docker Image
        run: |
          # Substitui placeholder e builda
          sed 's/TODO_WORKER_NAME/workers\/_template/g' workers/_template/Dockerfile > Dockerfile.test
          docker build -f Dockerfile.test -t test-worker .
      
      - name: Run Health Check
        run: |
          # Inicia container em background
          docker run -d -p 8080:8080 --name test-container test-worker
          
          # Aguarda startup
          sleep 5
          
          # Testa health endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health)
          
          if [ "$response" != "200" ]; then
            echo "Health check failed with status $response"
            docker logs test-container
            exit 1
          fi
          
          echo "âœ… Health check passed!"
          
      - name: Cleanup
        if: always()
        run: docker rm -f test-container || true
